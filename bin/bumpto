#!/usr/bin/env ruby

require 'fileutils'
require 'dotenv'

Dotenv.load('.env.local', '.env')

def system!(cmd)
  abort("Error en: #{cmd}") unless system(cmd)
end

def deduce_new_version
  engver = File.read('pg_rails/lib/version.rb')
  current_version = engver.match(/VERSION = '(.*)'/)[1]
  parts = current_version.split('-')
  if parts.length != 2
    raise 'no est√° en pre-release'
  end
  parts[0] + '-' + (parts[1].to_i + 1).to_s
end

newversion = ARGV[0]

unless newversion
  newversion = deduce_new_version
end

current_branch = `git branch --show-current`

pkgjson = File.read('package.json')
newcontent = pkgjson.sub /"version": .*,/, "\"version\": \"#{newversion}\","
File.write('package.json', newcontent)

engver = File.read('pg_rails/lib/version.rb')
newcontent = engver.sub /VERSION = .*/, "VERSION = '#{newversion}'"
File.write('pg_rails/lib/version.rb', newcontent)

system! 'bundle'

# system! 'bundle exec rake release_all'
